An instance of 3DR-AS comprises a set $N$ of $3n$ agents with additively separable preferences over triples, which we define as follows. Each agent $\alpha_i$ supplies a \textit{valuation function} $v_{\alpha_i} : N\setminus \{ {\alpha_i} \} \mapsto \mathbb{Z}$. Given agent $\alpha_i$, let the \emph{utility} of any set $S\subseteq N$ be $u_{\alpha_i}(S) = \sum_{{\alpha_j}\in S \setminus \{ \alpha_i \}} v_{\alpha_i}({\alpha_j})$. A \emph{triple} is an unordered set of three agents. We say that $\alpha_i \in N$ \emph{prefers} some triple $r$ to another triple $s$ if $u_{\alpha_i}(r) > u_{\alpha_i}(s)$. A \emph{matching} is a partition of $N$ into $n$ triples (note that we shall slightly modify this definition in Section~\ref{sec:threed_sr_as_findingastablematching}). Given an agent $\alpha_i$ and a matching $M$, we denote by $M(\alpha_i)$ the triple in $M$ that contains $\alpha_i$. Given a matching $M$, we say that a triple $t$ is \emph{blocking} if each agent $\alpha_i$ in $t$ prefers $t$ to $M(\alpha_i)$. A matching is \emph{stable} if it does not contain a blocking triple. An agent's preference between two matchings depends only on the partners of that agent in each matching, so given a matching $M$ we let $u_{\alpha_i}(M)$ be short for $u_{\alpha_i}(M(\alpha_i))$. Formally, we represent an instance of 3DR-AS as a pair $(N, V)$, where $V$ is the collection of all agents' valuation functions.

% The model that we present in this chapter is similar to those already discussed, and involves a set of agents $N=\{\alpha_1,\dots,\alpha_{3n}\}$ with preferences. It also involves the construction of a set of disjoint triples. For technical purposes, here we relax the condition that a matching is a partition of the agent set. We say that a \emph{matching} $M$ is a set of disjoint triples in which each agent belongs to at most one triple. For any agent $\alpha_i$, if some triple in $M$ contains $\alpha_i$ then we say that $\alpha_i$ is \emph{matched} and use $M(\alpha_i)$ to refer to that triple. If no triple in $M$ contains $\alpha_i$ then we say that $\alpha_i$ is \emph{unmatched} and write $M(\alpha_i) = \varnothing$. Given a matching $M$ and two distinct agents $\alpha_i, \alpha_j$, if $M(\alpha_i)=M(\alpha_j)$ then we say that $\alpha_j$ is a \textit{partner} of $\alpha_i$.

% We define \emph{additively separable preferences} as follows. 

% Suppose we have some pair $(N, V)$ and a matching $M$ involving the agents in $N$. We say that a triple $\{\alpha_{k_1}, \alpha_{k_2}, \alpha_{k_3} \}$ \textit{blocks} $M$ in $(N, V)$ if $u_{\alpha_{k_1}}(\{\alpha_{k_2}, \alpha_{k_3} \}) > u_{\alpha_{k_1}}(M), u_{\alpha_{k_2}}(\{\alpha_{k_1}, \alpha_{k_3} \}) > u_{\alpha_{k_2}}(M)$, and $u_{\alpha_{k_3}}(\{\alpha_{k_1}, \alpha_{k_2} \}) > u_{\alpha_{k_3}}(M)$. If no triple in $N$ blocks $M$ in $(N, V)$ then we say that $M$ is \textit{stable} in $(N, V)$. We say that $(N, V)$ \emph{contains} a stable matching if at least one matching exists in $(N, V)$ that is stable.

For any instance $(N, V)$ of 3DR-AS and any matching $M$ in $(N, V)$, for a set $S \subseteq N$ of agents we define the \emph{utilitarian welfare} of $S$ as $u_{S}(M) = \sum_{\alpha_i \in S} u_{\alpha_i}(M)$. Let $u(M)$ be short for $u_{N}(M)$.

We also define three possible restrictions of agents' preferences. We say that valuations are \emph{binary}, if $v_{\alpha_i}(\alpha_j) \in \{ 0, 1 \}$ for any $\alpha_i, \alpha_j \in N$, \emph{ternary} if $v_{\alpha_i}(\alpha_j) \in \{ 0, 1, 2 \}$ for any $\alpha_i, \alpha_j \in N$, and \emph{symmetric} if $v_{\alpha_i}(\alpha_j)=v_{\alpha_j}(\alpha_i)$ for any $\alpha_i, \alpha_j \in N$.

It is possible to consider an instance of 3DR-AS as a weighted directed graph, in which the set of vertices is the set of agents and the weight of any arc from one agent to another is the corresponding valuation. In particular, an instance of 3DR-AS with binary and symmetric preferences corresponds directly to an undirected graph, which we shall refer to as the \emph{underlying graph}.

% Lemma~\ref{lem:threed_sr_as_blockerimprovement} illustrates a fundamental property of stable matchings in instances of 3DR-AS. We shall use it extensively in the proofs.
By the definition of stability, if $M$ and $M'$ are matchings in some instance of 3DR-AS, $M$ is stable, and $u_{\alpha_i}(M') \geq u_{\alpha_i}(M)$ for any agent $\alpha_i$ then it must follow that $M'$ is also stable. We prove a related statement in Proposition~\ref{prop:threed_sr_as_blockerimprovement}.
\begin{prop}
\label{prop:threed_sr_as_blockerimprovement}
Given an instance $(N, V)$ of 3DR-AS, suppose that $M$ and $M'$ are matchings in $(N, V)$. Any triple that blocks $M'$ but does not block $M$ contains at least one agent $\alpha_i \in N$ where $u_{\alpha_i}(M') < u_{\alpha_i}(M)$.
\end{prop}
\begin{proof}
Suppose some triple $\{ \alpha_i, \alpha_j, \alpha_k \}$ blocks $M'$. By the definition of a blocking triple, it must be that $u_{\alpha_i}(\{\alpha_j, \alpha_k \}) > u_{\alpha_i}(M')$, $u_{\alpha_j}(\{\alpha_i, \alpha_k \}) > u_{\alpha_j}(M')$, and $u_{\alpha_k}(\{\alpha_i, \alpha_j \}) > u_{\alpha_k}(M')$. Suppose for a contradiction that there exists no $\alpha_p\in \{ \alpha_i, \alpha_j, \alpha_k \}$ exists where $u_{\alpha_p}(M') < u_{\alpha_p}(M)$ and hence $u_{\alpha_{k_r}}(M') \geq u_{\alpha_{k_r}}(M)$ for $1 \leq r \leq 3$. It follows that $u_{\alpha_i}(\{\alpha_j, \alpha_k \}) > u_{\alpha_i}(M)$, $u_{\alpha_j}(\{\alpha_i, \alpha_k \}) > u_{\alpha_j}(M)$, and $u_{\alpha_k}(\{\alpha_i, \alpha_j \}) > u_{\alpha_k}(M)$ and thus that $\{ \alpha_i, \alpha_j, \alpha_k \}$ also blocks $M$, which is a contradiction.
\end{proof}

We also introduce some other notation. We denote by $L = \langle l_1, l_2, \dots, l_{|L|} \rangle$ an ordered list. If $L$ and $L'$ are lists then we denote by $L \cdot L'$ the concatenation of $L'$ to the end of $L$. We also use standard set notation with lists, such as $e \in L$.