As before in Theorem~\ref{thm:threed_efr_as_regularenvy_npcomplete}, in this section we consider instances of 3DR-AS with binary and symmetric preferences and maximum degree $3$. Here we show that, in contrast with Theorem~\ref{thm:threed_efr_as_wjef_algowjpathscycles}, deciding if a given instance of 3DR-AS contains a wj-envy-free matching is $\NP$-complete, even when preferences are binary and symmetric and the maximum degree is $3$.

As before in Section~\ref{sec:threed_efr_as_envyfreeness_maxdeg3}, we reduce from \porschenxsatvariant/ (Problem~\ref{pr:xsatvariant}). Here we assume that the number of clauses $m$ satisfies $m=4l$ for some $l\geq 1$. We can show that the wj-envy-free existence problem remains $\NP$-complete under this restriction as follows. Construct four distinct copies of the set of variables $X(C)$ and formula $C$. Let the constructed formula $C'$ be the union of the four copies of $C$. It is straightforward to show that $C'$ is exactly satisfiable if and only if each of the four copies is exactly satisfiable, which is true if and only if the original formula $C$ is exactly satisfiable.

The main difference between this reduction and the reduction for the 3DR-AS envy-free decision problem is in the second direction, in which we show that $C$ is exactly satisfiable if a wj-envy-free matching $M$ exists in the constructed instance $(N, E)$. Here we associate true literals with variable gadgets that belong to one triple (rather than three) and false literals with variable gadgets that belong to three triples (rather than one). Another difference is that we construct a number of garbage collector gadgets. We will show that there is only one possible configuration of the triples of agents in the garbage collector gadgets in a wj-envy-free matching.

% Given an instance $C$ of \porschenxsatvariant/, the reduction constructs an instance of 3DR-AS with binary and symmetric preferences $(N, E)$ such that $C$ is exactly satisfiable if and only if a wj-envy-free matching exists in $(N, E)$. 

The reduction, illustrated in Figure~\ref{fig:threed_efr_as_wj_envy_free_reduction}, is as follows. Suppose $C$ is an arbitrary instance of \porschenxsatvariant/. We shall construct an instance $(N, E)$ of 3DR-AS.

For each variable $x_i \in X(C)$ construct a set of three agents $W_i = \{ w_i^1, w_i^2, w_i^3 \}$, which we refer to as the \emph{$i\textsuperscript{th}$ variable gadget}. Add the edges $\{ w_i^1, w_i^2 \}$, $\{ w_i^2, w_i^3 \}$, and $\{ w_i^3, w_i^1 \}$ to $E$. Next, for each clause $c_r$ in $C$ construct a set of four agents $D_r = \{ d_r^1, d_r^2, d_r^3, d_r^4 \}$,  which we refer to as the \emph{$r\textsuperscript{th}$ clause gadget}. Add the edges $\{ d_r^1, d_r^4 \}$, $\{ d_r^2, d_r^4 \}$, and $\{ d_r^3, d_r^4 \}$. Recall that $3$ divides $m$ and $m=4l$ for some integer $l>1$. Construct a set of $12l$ agents labelled $g_1, g_2, \dots, g_{12l}$. For any $i$ where $1\leq i\leq 3l$, we shall refer to $G_i = \{ g_{4i-3}, g_{4i-2}, g_{4i-1}, g_{4i} \}$ as the \emph{$i\textsuperscript{th}$ garbage collector gadget}. For each $1\leq i\leq 3l$, add the edges $\{ g_{4i}, g_{4i-1} \}$, $\{ g_{4i}, g_{4i-2} \}$, and $\{ g_{4i}, g_{4i-3} \}$ to $E$. Note that each garbage collector gadget $G_i$ is an isolated claw $K_{1,3}$. 
We shall connect the variable and clause gadgets are connected in the way as the reduction in Section~\ref{sec:threed_efr_as_envyfreeness_maxdeg3}. Consider each clause $c_r = \{ x_i, x_j, x_k \}$. If $c_r$ contains the $j\textsuperscript{th}$ occurrence of $x_i$ then add the edge $\{ d_r^1, w_i^j \}$. Similarly, add an edge between $d_r^2$ and an agent in $W_j$ depending on the index of the occurrence of $x_j$ in the clause $c_r$ and an edge between $d_r^3$ and an agent in $W_k$ depending on the index of the occurrence of $x_k$ in the clause $c_r$.

This completes the construction of $(N, E)$. Note that each agent in a variable gadget has degree $3$, $d_r^1, d_r^2, d_r^3$ for each $1 \leq r \leq m$ have degree $2$, $d_r^4$ for each $1 \leq r \leq m$ has degree $3$, $g_i$ where $1\leq i\leq 12l$ and $i$ is not divisible by four has degree $1$, and $g_j$ where $1\leq j\leq 12l$ and $j$ is divisible by four has degree $3$. It follows that the maximum degree of $(N, E)$ is $3$.

It is straightforward to show that this reduction can be performed in polynomial time. To prove that the reduction is correct we show that the 3DR-AS instance $(N, E)$ contains a wj-envy-free matching if and only if the \porschenxsatvariant/ instance $C$ is exactly satisfiable.

\begin{figure}
    \centering
    \input{figures/threed_efr_as/wj_envy_free_reduction.tikz}
    \caption[The reduction from \porschenxsatvariant/ to the problem of deciding if a given instance of 3DR-AS contains an wj-envy-free matching]{The reduction from \porschenxsatvariant/ to the problem of deciding if a given instance of 3DR-AS contains an wj-envy-free matching. A variable gadget $W_i$, clause gadget $D_r$, and garbage collector gadget $G_i$ are represented as undirected graphs.}
    \label{fig:threed_efr_as_wj_envy_free_reduction}
\end{figure}

We first show that if the \porschenxsatvariant/ instance $C$ is exactly satisfiable then the 3DR-AS instance $(N, E)$ contains a wj-envy-free matching.

\begin{lem}
\label{lem:threed_efr_as_wjenvy_firstdirection}
If $C$ is exactly satisfiable then $(N, E)$ contains a wj-envy-free matching.
\end{lem}
\begin{proof}
Suppose $f$ is an exact model in $C$. We shall construct a matching $M$ in $(N, E)$ that is wj-envy-free. For each variable $x_i$ in $X(C)$ where $f(x_i)$ is true, add $\{ w_i^1, w_i^2, w_i^3 \}$ to $M$. Next, consider each clause $c_r = \{ x_i, x_j, x_k \}$ and the corresponding clause gadget $D_r$, labelling $i, j, k$ such that $W_i$ contains an agent adjacent to $d_r^1$, $W_j$ contains an agent adjacent to $d_r^2$, and $W_k$ contains an agent adjacent to $d_r^3$. There are three cases: $f(x_i)$ is true while both $f(x_j)$ and $f(x_k)$ are false, $f(x_j)$ is true while both $f(x_i)$ and $f(x_k)$ are false, and $f(x_k)$ is true while both $f(x_i)$ and $f(x_j)$ are false. In the first case, suppose $c_r$ contains the $a\textsuperscript{th}$ occurrence of $x_j$ and the $b\textsuperscript{th}$ occurrence of $x_k$. Add the triples $\{ d_r^1, d_r^4, g_{3r} \}$, $\{ d_r^2, w_j^a, g_{3r-1} \}$, and $\{ d_r^3, w_k^b, g_{3r-2} \}$. The constructions in the second and third cases are symmetric: in the second case, suppose $c_r$ contains the $a\textsuperscript{th}$ occurrence of $x_i$ and the $b\textsuperscript{th}$ occurrence of $x_k$. Add the triples $\{ d_r^2, d_r^4, g_{3r} \}$, $\{ d_r^1, w_i^a, g_{3r-1} \}$, and $\{ d_r^3, w_k^b, g_{3r-2} \}$. In the third case, suppose $c_r$ contains the $a\textsuperscript{th}$ occurrence of $x_i$ and the $b\textsuperscript{th}$ occurrence of $x_j$. Add the triples $\{ d_r^3, d_r^4, g_{3r} \}$, $\{ d_r^1, w_i^a, g_{3r-1} \}$, and $\{ d_r^2, w_j^b, g_{3r-2} \}$. 

Note that for any triple $t\in M$, either $t=W_i$ for some variable gadget $W_i$; $t=\{ d_r^4, d_r^a, g_{3r} \}$ where $1\leq r\leq m$ and $1\leq a \leq 3$; or $t=\{ d_r^a, w_i^b, g_j \}$ where $1\leq i, r \leq m$, $1\leq a, b \leq 3$ and $1\leq j\leq 12l$ where $j$ is not divisible by three. We shall show that in each case $t$ does not contain an agent with wj-envy.

First, consider some triple $t\in M$ where $t=W_i$ for some variable gadget $W_i$. Since each agent in $t$ has utility $2$, no agent in $t$ is envious.

Second, consider some triple $t\in M$ where $t=\{ d_r^4, d_r^a, g_{3r} \}$, $1\leq r\leq m$, and $1\leq a \leq 3$. Since $M(d_r^1)\neq M(d_r^2)$, $M(d_r^1)\neq M(d_r^3)$, and $M(d_r^2)\neq M(d_r^3)$, it must be that $\sigma(N(d_r^4), M)=3$. Since $u_{d_r^4}(M)=1$, it follows by Lemma~\ref{lem:threed_efr_as_util1_neighbourhoodthreetriples} that $d_r^4$ is not envious. Similarly, since $M(d_r^a)=\{ d_r^4, d_r^a, g_{3r} \}$ it follows that $\sigma(N(d_r^a), M)=2$ so since $u_{d_r^a}(M)=1$ by Lemma~\ref{lem:threed_efr_as_util1_neighbourhoodthreetriples} it must be that $d_r^a$ is also not envious. Suppose for a contradiction that $g_{3r}$ wj-envies some agent $\alpha_j$. It must be that $u_{g_{3r}}(M(\alpha_j) \setminus \{ \alpha_j \})\geq 1$ so $M(\alpha_j)$ contains some $g_q$ where $\{ g_{3r}, g_q \} \in E$. Let $M(\alpha_j) = \{ \alpha_j, g_q, \alpha_k \}$. By construction of $M$, it must be that $\alpha_j, \alpha_k \subset D_s$ where $1\leq s\leq m$ and $u_{\alpha_j}(M)=u_{\alpha_k}(M)=1$. It follows that $\{ \alpha_k, g_q \} \notin E$ so $u_{\alpha_k}(M) < u_{\alpha_k}(\{ g_q, g_{3r} \})$, which contradicts the supposition that $g_{3r}$ wj-envies $\alpha_j$.

Third, consider some triple $t\in M$ where $t=\{ d_r^a, w_i^b, g_j \}$,  $1\leq i, r \leq m$, $a \in \{1, 2, 3 \}$, $b \in \{ 1, 2, 3 \}$ and $1\leq j\leq 12l$ where $j$ is not divisible by three. By construction, $\sigma(N(w_i^b), M)=3$ so by Lemma~\ref{lem:threed_efr_as_util1_neighbourhoodthreetriples} $w_i^b$ is not envious. Similarly, since $M(d_r^a)=\{ d_r^a, w_i^b, g_{j} \}$ it follows that $\sigma(N(d_r^a), M)=2$ so since $u_{d_r^a}(M)=1$ by Lemma~\ref{lem:threed_efr_as_util1_neighbourhoodthreetriples} it must be that $d_r^a$ is also not envious. As before, suppose for a contradiction that $g_{j}$ wj-envies some agent $\alpha_k$. It must be that $u_{g_{j}}(M(\alpha_k) \setminus \{ \alpha_k \})\geq 1$ so $M(\alpha_k)$ contains some $g_q$ where $\{ g_{j}, g_q \} \in E$. Let $M(\alpha_k) = \{ \alpha_k, g_q, \alpha_h \}$. By construction of $M$, it must be that $\alpha_k, \alpha_h \subset D_s$ for some $s$ where $1\leq s\leq m$ and $u_{\alpha_k}(M)=u_{\alpha_h}(M)=1$. It follows that $\{ \alpha_h, g_q \} \notin E$ so $u_{\alpha_h}(M) < u_{\alpha_h}(\{ g_q, g_{j} \})$, which contradicts the supposition that $g_{j}$ wj-envies $\alpha_k$.
\end{proof}

We now show, using a sequence of lemmas, that if the 3DR-AS instance $(N, E)$ contains an wj-envy-free matching then the \porschenxsatvariant/ instance $C$ is exactly satisfiable.

\begin{lem}
\label{lem:threed_efr_as_wjenvy_seconddirection_triangle_split_stay}
If $(N, E)$ contains an envy-free matching $M$ then for any variable gadget $W_i$, either $\sigma(W_i, M)=1$ or $\sigma(W_i, M)=3$.
\end{lem}
\begin{proof}
The proof is similar to Lemma~\ref{lem:threed_efr_as_regularenvy_seconddirection_triangle_split_stay}. If some triple in $M$ contains exactly two agents in $W_i$ then the third agent in $W_i$ is wj-envious.
\end{proof}

\begin{lem}
\label{lem:threed_efr_as_wjenvy_giscores0}
If $(N, E)$ contains an envy-free matching $M$ then $u_{g_i}(M)=0$ for any $i$ where $1\leq i\leq 12l$.
\end{lem}
\begin{proof}
Suppose $M$ is a wj-envy-free matching. By construction, the structure of $G_i$ for each $1\leq i\leq 3l$ is identical, so to simplify the proof we assume, without loss of generality, that $i=1$ and $G_i=\{ g_1, g_2, g_3, g_4 \}$. We shall prove that $\sigma(G_1, M)=4$, from which it follows directly that $u_{g_1}(M)=u_{g_2}(M)=u_{g_3}(M)=u_{g_4}(M)=0$. Since $|G_1|=4$ clearly $\sigma(G_1, M) \leq 4$. Suppose for a contradiction that $\sigma(G_1, M) \leq 3$. Then there exists two agents $g_a, g_b \in G_1$ where $g_a \in M(g_b)$. Label the third agent in $M(g_b)$ as $\alpha_j$. By symmetry, we need only consider two cases. In the first case, $a=1$ and $b=4$. In the second case, $a=1$ and $b=2$. We will show that in both cases it is relatively straightforward to identify an envious agent, which is a contradiction.

First, suppose $a=1$ and $b=4$. Since $\{ g_1, g_4 \} \subset M(g_4)$, by construction it must be that either $u_{g_2}(M)=0$ or $u_{g_3}(M)=0$. Assume without loss of generality that $u_{g_2}(M)=0$. It follows that $g_2$ wj-envies $g_1$, since $u_{g_4}(\{ g_1, \alpha_j \}) = u_{g_4}(\{ g_2, \alpha_j \})$ and, by construction of $G_1$, $u_{\alpha_j}(\{ g_4, g_1 \}) = u_{\alpha_j}(\{ g_4, g_2 \})$. 

Second, suppose $a=1$ and $b=2$. There are two cases: $g_4=\alpha_j$ or $g_4\neq \alpha_j$. If $g_4=\alpha_j$ then $g_3$ wj-envies $g_2$, since $u_{g_1}(\{ g_2, g_4 \}) = u_{g_1}(\{ g_3, g_4 \})$ and $u_{g_4}(\{ g_1, g_2 \}) = u_{g_4}(\{ g_2, g_3 \})$. If $g_4\neq \alpha_j$ then $u_{g_4}(M)\leq 1$ so $g_4$ wj-envies $\alpha_j$, since $u_{g_4}(\{ g_1, g_2 \})=2$, $u_{g_1}(M)=u_{g_2}(M)=0$, and $u_{g_1}(\{ g_2, g_4 \})=u_{g_2}(\{ g_1, g_4 \})=1$.
\end{proof}

\begin{lem}
\label{lem:threed_efr_as_wjenvy_gi011}
If $(N, E)$ contains an envy-free matching $M$ then $M(g_i) = \{ g_i, \alpha_a, \alpha_b \}$ where $\{ \alpha_a, \alpha_b \} \in E$ for any $1\leq i\leq 12l$.
\end{lem}
\begin{proof}
Suppose $M$ is a wj-envy-free matching. Consider an arbitrary $g_i$ where $1\leq i \leq 12l$. Let $g_j$ be some agent for which $\{ g_i, g_j \} \in E$. By Lemma~\ref{lem:threed_efr_as_wjenvy_giscores0}, $u_{g_i}(M)=u_{g_j}(M)=0$. It remains to show $\{ \alpha_a, \alpha_b \} \in E$. Suppose for a contradiction that $\{ \alpha_a, \alpha_b \} \notin E$. It follows that $u_{\alpha_a}(M)=u_{\alpha_b}(M)=u_{g_i}(M)=0$. Now $g_j$ wj-envies $\alpha_a$, since $u_{g_j}(\{ g_i, \alpha_b \})=1$, $u_{\alpha_b}(\{ g_j, g_i \})=u_{\alpha_b}(M)$, and $u_{g_i}(\{ g_j, \alpha_b \})=1$, which is a contradiction.
\end{proof}

\begin{lem}
\label{lem:threed_efr_as_3triplesperclausegadget}
Suppose $(N, E)$ contains a wj-envy-free matching $M$. For each $1\leq r \leq m$, there exist exactly three triples $t_1, t_2, t_3$ that each contains one agent in $G$ and at least one agent $d_r^w \in D_r$ where $u_{d_r^w}(M)=1$.
\end{lem}
\begin{proof}
By Lemma~\ref{lem:threed_efr_as_wjenvy_gi011}, $M(g_i) = \{ g_i, \alpha_a, \alpha_b \}$ where $\{ \alpha_a, \alpha_b \} \in E$ for any $i$ where $1\leq i\leq 12l$. It follows that there exists $12l$ triples in $M$ of the form $\{ g_i, \alpha_a, \alpha_b \}$ where $\{ \alpha_a, \alpha_b \} \in E$. Let $T$ be this set of triples. Since $\{ \alpha_a, \alpha_b \} \in E$, it must be that $u_{\alpha_a}(M)=u_{\alpha_b}(M)=1$. It follows that $\alpha_a \notin G$ and $\alpha_b \notin G$. It must be that for any $\{ g_i, \alpha_a, \alpha_b \} \in T$ there exists some $1\leq r\leq m$ where either $\alpha_a \in D_r$ or $\alpha_b \in D_r$, for otherwise the only possibility is that $\{ \alpha_a, \alpha_b \} \subset W_i$ for some variable gadget $W_i$, which would contradict Lemma~\ref{lem:threed_efr_as_wjenvy_seconddirection_triangle_split_stay}. We have now shown that each $t\in T$ comprises $\{ g_i, d_r^w, \alpha_b \}$ where $u_{d_r^w}(M)=u_{\alpha_b}(M)=1$ for some $1\leq r\leq m$, $1\leq w \leq 4$ and $\alpha_b\in N$. It remains to show that for a given $r$, there exist exactly three triples in $T$ where each triple contains at least one agent in $D_r$. 

Suppose for a contradiction that there exists some $1\leq r\leq m$ where the number of triples in $T$ that contain an agent in $D_r$ is not three. Recall that $|T|=12l$, $m=4l$, and each $t\in T$ contains at least one agent $d_r^w$ where $1\leq r\leq m$ and $1\leq w\leq 4$. A counting argument shows that there must exist some $1\leq s\leq m$ where there are at least four triples $t_1,t_2,t_3,t_4 \in T$ that each contain at least one agent in $D_s$. Without loss of generality, it must be that $d_s^1\in t_1$, $d_s^2\in t_2$, $d_s^3\in t_3$, and $d_s^4\in t_4$. Since we have previously established that $u_{d_s^4}(M)=1$ this leads to a contradiction since $N(d_s^4)=\{ d_s^1, d_s^2, d_s^3 \}$ but $d_s^1\notin t_4$, $d_s^2\notin t_4$, and $d_s^3\notin t_4$. It follows that for each $1\leq r\leq m$, there exists exactly three triples in $T$ where each triple contains at least one agent in $D_r$.
\end{proof}

\begin{lem}
\label{lem:threed_efr_as_wjenvy_seconddirection}
If $(N, E)$ contains an envy-free matching then $C$ is exactly satisfiable.
\end{lem}
\begin{proof}
Suppose $M$ is a wj-envy-free matching in $(N, E)$. By Lemma~\ref{lem:threed_efr_as_wjenvy_seconddirection_triangle_split_stay}, for any variable gadget $W_i$ either $\sigma(W_i, M)=1$ or $\sigma(W_i, M)=3$. Construct a truth assignment $f$ in $C$ by setting $f(x_i)$ to be true if $\sigma(W_i, M)=1$ and false otherwise. Each variable $x_i$ corresponds to exactly one variable gadget $W_i$ so it follows that $f$ is a valid truth assignment. By the construction of $(N, E)$, each clause $c_r$ corresponds to exactly one clause gadget $D_r$. Each clause gadget is adjacent to three variable gadgets that correspond to the three variables in that clause. To show that $f$ is an exact model of $C$, it is sufficient to show that for each clause gadget $D_r$ there exists exactly one variable gadget $W_i$ such that $D_r$ is adjacent to $W_i$ and $\sigma(W_i, M)=1$.

Consider an arbitrary clause gadget $D_r$ and the corresponding clause $c_r=\{ x_i, x_j, x_k\}$, labelling $i, j, k$ such that $d_r^1$ is adjacent to some agent $w_i^{a_1} \in W_i$, $d_r^2$ is adjacent to some agent $w_j^{a_2} \in W_j$ and $d_r^3$ is adjacent to some agent $w_k^{a_3} \in W_k$. By Lemma~\ref{lem:threed_efr_as_3triplesperclausegadget}, there exists exactly three triples $t_1, t_2, t_3$ such that $t_1$ contains one agent $g_{h_1}\in G$ and at least one agent $d_r^{b_1} \in D_r$ where $u_{d_r^{b_1}}(M)=1$; $t_2$ contains one agent $g_{h_2}\in G$ and at least one agent $d_r^{b_2} \in D_r$ where $u_{d_r^{b_2}}(M)=1$; and $t_3$ contains one agent in $g_{h_3}\in G$ and at least one agent $d_r^{b_3} \in D_r$ where $u_{d_r^{b_3}}(M)=1$. Consider $d_r^4$. If $u_{d_r^4}(M)=0$ then $\{ b_1, b_2, b_3 \} = \{ 1, 2, 3 \}$ so without loss of generality we may assume that  $t_1 = \{ d_r^1, w_i^{a_1}, g_{h_1} \}$, $t_2 = \{ d_r^2, w_j^{a_2}, g_{h_2} \}$, and $t_3 = \{ d_r^3, w_k^{a_3}, g_{h_3} \}$. In this configuration $d_r^4$ wj-envies $w_i^{a_1}$ since $u_{d_r^4}(\{ d_r^1, g_{h_1} \})=1$, $u_{d_r^1}(\{ d_r^4, g_{h_1} \}) = u_{d_r^1}(M)$, and $u_{g_{h_1}}(\{ d_r^4, d_r^1 \}) = u_{g_{h_1}}(M) = 0$. It follows that $u_{d_r^4}(M)>0$. Recalling our earlier observation (in this proof) on the contents of $t_1$, $t_2$, and $t_3$ it must be that $u_{d_r^4}(M)<2$ and so $u_{d_r^4}(M)=1$. There are three possible cases: either $d_r^1 \in M(d_r^4)$, $d_r^2 \in M(d_r^4)$, or $d_r^3 \in M(d_r^4)$. By the symmetry of the clause gadget, we describe only the case in which $d_r^1 \in M(d_r^4)$. Without loss of generality we may assume that $t_1 = \{ d_r^1, d_r^4, g_h^1 \}$. Furthermore, we may assume that $t_2 = \{ d_r^2, w_j^{a_2}, g_{h_2} \}$ and $t_3 = \{ d_r^3, w_k^{a_3}, g_{h_3} \}$. Consider $w_i^{a_1}$. If $u_{w_i^{a_1}}(M)=0$ then $w_i^{a_1}$ wj-envies $d_r^4$, since $u_{w_i^{a_1}}(\{ d_r^1, g_{h_1} \})=1$, $u_{d_r^1}(\{ w_i^{a_1}, g_{h_1} \}) = u_{d_r^1}(M)$, and $u_{g_{h_1}}(\{ w_i^{a_1}, d_r^1 \}) = u_{g_{h_1}}(M) = 0$. It must be that $u_{w_i^{a_1}}(M)>0$. If $u_{w_i^{a_1}}(M)=1$ then Lemma~\ref{lem:threed_efr_as_wjenvy_seconddirection_triangle_split_stay} is contradicted. It follows that $u_{w_i^{a_1}}(M)=2$ and thus $\sigma(W_i, M)=1$. Now consider $w_j^{a_2}$ and $w_k^{a_3}$. Since $u_{w_j^{a_2}}(M)=1$ it must be that $\sigma(W_j, M)=3$. Similarly, since $u_{w_k^{a_3}}(M)=1$ it must be that $\sigma(W_k, M)=3$. To recap, after we supposed that $d_r^1 \in M(d_r^4)$, we showed that $\sigma(W_i, M)=1$ and $\sigma(W_j, M)=\sigma(W_k, M)=3$, as required. The cases in which $d_r^2 \in M(d_r^4)$ or $d_r^3 \in M(d_r^4)$ are symmetric.
\end{proof}

We have now shown that the 3DR-AS instance $(N, E)$ contains a wj-envy-free matching if and only if the \porschenxsatvariant/ instance $C$ is exactly satisfiable. This shows that the reduction is correct.

\begin{thm}
\label{thm:threed_efr_as_wjef_npcomplete}
Deciding if a given instance of 3DR-AS contains a wj-envy-free matching is $\NP$-complete, even when preferences are binary and symmetric and maximum degree is $3$.
\end{thm}
\begin{proof}
It is straightforward to show that this decision problem belongs to $\NP$, since for any two agents $\alpha_i, \alpha_j \in N$ we can test if $\alpha_i$ wj-envies $\alpha_j$ in constant time. 

We have presented a polynomial-time reduction from \porschenxsatvariant/, which is $\NP$-complete \cite{PSSW14}. Given an arbitrary instance $C$ of \porschenxsatvariant/, the reduction constructs an instance $(N, E)$ of 3DR-AS with binary and symmetric preferences and maximum degree $3$. Lemmas~\ref{lem:threed_efr_as_wjenvy_firstdirection} and~\ref{lem:threed_efr_as_wjenvy_seconddirection} show that $(N, E)$ contains a wj-envy-free matching if and only if $C$ is exactly satisfiable and thus that this decision problem is $\NP$-hard.
\end{proof}

